{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <h2>Podsumowanie</h2>
        <div class="card mb-4">
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Suma Aktywów (Płynnych): <strong>{{ "%.2f"|format(aktywa_płynne) }} zł</strong></li>
                <li class="list-group-item">Majątek Netto (Płynny): <strong>{{ "%.2f"|format(majatek_netto_plynny) }} zł</strong></li>
                <li class="list-group-item">Wartość Nieruchomości: <strong>{{ "%.2f"|format(wartosc_nieruchomosci) }} zł</strong></li>
                <li class="list-group-item active">Majątek Netto (Całkowity): <strong>{{ "%.2f"|format(majatek_netto_calkowity) }} zł</strong></li>
            </ul>
            <div class="card-footer text-center">
                <form action="{{ url_for('save_net_worth_snapshot') }}" method="POST">
                    <button type="submit" class="btn btn-info">Zapisz stan na dziś (snapshot)</button>
                </form>
            </div>
        </div>

        <h4 class="mt-4">Dodaj Aktywa</h4>
        <form action="{{ url_for('add_asset') }}" method="POST">
            <div class="mb-2"><input type="text" name="nazwa" placeholder="Nazwa" class="form-control" required></div>
            <div class="mb-2"><input type="number" step="0.01" name="wartosc" placeholder="Wartość" class="form-control" required></div>
            <div class="mb-2"><select name="typ" class="form-select" required><option value="płynne">Płynne</option><option value="nieruchomość">Nieruchomość</option></select></div>
            <button type="submit" class="btn btn-success btn-sm">Dodaj Aktywa</button>
        </form>

        <h4 class="mt-4">Dodaj Pasywa</h4>
        <form action="{{ url_for('add_liability') }}" method="POST">
            <div class="mb-2"><input type="text" name="nazwa" placeholder="Nazwa" class="form-control" required></div>
            <div class="mb-2"><input type="number" step="0.01" name="wartosc" placeholder="Wartość (bez minusa)" class="form-control" required></div>
            <button type="submit" class="btn btn-danger btn-sm">Dodaj Pasywa</button>
        </form>
    </div>

    <div class="col-md-8">
        <div class="row">
            <div class="col-lg-12 mb-4">
                <h4>Historia poszczególnych aktywów płynnych</h4>
                <canvas id="multiAssetChart"></canvas>
            </div>
            <div class="col-lg-12 mb-4">
                <h4>Historia sumy aktywów płynnych</h4>
                <canvas id="totalAssetsChart"></canvas>
            </div>
        </div>
        <hr>
        
        <h2>Aktywa</h2>
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>Nazwa</th>
                    <th class="text-end">Wartość</th>
                    <th class="text-center">Akcja</th>
                </tr>
            </thead>
            <tbody>
                {% for a in aktywa %}
                <tr>
                    <td>{{ a['nazwa'] }} ({{ a['typ'] }})</td>
                    <td class="text-end">
                        <form action="{{ url_for('edit_asset', id=a['id']) }}" method="POST" class="d-inline-flex">
                            <input type="number" step="0.01" name="wartosc" value="{{ a['wartosc'] }}" class="form-control form-control-sm" style="width: 120px;">
                            <button type="submit" class="btn btn-sm btn-outline-secondary ms-2"><i class="bi bi-arrow-clockwise"></i></button>
                        </form>
                    </td>
                    <td style="width: 50px;" class="text-center">
                        <a href="{{ url_for('delete_asset', id=a['id']) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2 class="mt-4">Pasywa</h2>
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>Nazwa</th>
                    <th class="text-end">Wartość</th>
                    <th class="text-center">Akcja</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pasywa %}
                <tr>
                    <td>{{ p['nazwa'] }}</td>
                    <td class="text-end">
                        <form action="{{ url_for('edit_liability', id=p['id']) }}" method="POST" class="d-inline-flex align-items-center">
                            <span>-</span>
                            <input type="number" step="0.01" name="wartosc" value="{{ p['wartosc'] }}" class="form-control form-control-sm" style="width: 120px;">
                            <span class="ms-1">zł</span>
                            <button type="submit" class="btn btn-sm btn-outline-secondary ms-2"><i class="bi bi-arrow-clockwise"></i></button>
                        </form>
                    </td>
                    <td style="width: 50px;" class="text-center">
                        <a href="{{ url_for('delete_liability', id=p['id']) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<hr class="my-4">
<h2>Historia Wartości Aktywów Płynnych</h2>

{% if history_table_rows %}
<table class="table table-sm table-hover">
    <thead>
        <tr>
            <th>Data</th>
            {% for header in history_table_headers %}
                <th class="text-end">{{ header }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in history_table_rows %}
        <tr>
            <td>{{ row['data'] }}</td>
            {% for header in history_table_headers %}
                <td class="text-end">{{ "%.2f"|format(row[header]) }} zł</td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted">Brak wystarczających danych historycznych. Zrób co najmniej dwa snapshoty w różne dni, aby zobaczyć historię.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script id="history-data" type="application/json">{{ {
    'labels': history_labels, 
    'datasets': history_datasets, 
    'total': total_assets_history
}|tojson }}</script>
<script>
    const historyDataSource = document.getElementById('history-data');
    if (historyDataSource) {
        const historyData = JSON.parse(historyDataSource.textContent);
        
        if (historyData.labels && historyData.labels.length > 0) {
            
            // --- WYKRES 1: Wiele Linii (Poszczególne Aktywa) ---
            const multiAssetCanvas = document.getElementById('multiAssetChart');
            if (multiAssetCanvas && historyData.datasets) {
                const datasets = [];
                const colors = ['rgb(75, 192, 192)', 'rgb(255, 205, 86)', 'rgb(54, 162, 235)', 'rgb(153, 102, 255)', 'rgb(255, 99, 132)', 'rgb(255, 159, 64)'];
                let colorIndex = 0;

                for (const [label, data] of Object.entries(historyData.datasets)) {
                    datasets.push({
                        label: label,
                        data: data,
                        borderColor: colors[colorIndex % colors.length],
                        tension: 0.1,
                        fill: false
                    });
                    colorIndex++;
                }

                new Chart(multiAssetCanvas, {
                    type: 'line',
                    data: { labels: historyData.labels, datasets: datasets },
                    options: { 
                        responsive: true,
                        plugins: {
                           legend: { display: true, position: 'top' }
                        }
                    } 
                });
            }

            // --- WYKRES 2: Jedna Linia (Suma Aktywów Płynnych) ---
            const totalAssetsCanvas = document.getElementById('totalAssetsChart');
            if (totalAssetsCanvas && historyData.total) {
                new Chart(totalAssetsCanvas, {
                    type: 'line',
                    data: {
                        labels: historyData.labels,
                        datasets: [{
                            label: 'Suma Aktywów Płynnych',
                            data: historyData.total,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    }
                });
            }
        }
    }
</script>
{% endblock %}